---
title: "ARE 213 Problem Set 3"
author: "Becky Cardinali, Yuen Ho, Sara Johns, and Jacob Lefler"
date: "12/7/2020"
header-includes: 
  - \usepackage{float}
  - \floatplacement{figure}{H}
  - \usepackage{amsmath}
output: pdf_document
fig_caption: yes
geometry: margin=1.5cm
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#======================
# Section 0: Set Up
#======================

# Clear workspace
rm(list = ls())

# Load packages
library(pacman)
library(zoo)
library(haven)
p_load(coefplot, data.table, dplyr, foreign, readstata13, tidyr, xtable, broom, stringr, glue,
       ggplot2, stats, FNN, fastDummies, fixest, parallel, plm, lmtest, fixest, Synth, sandwich,
       SCtools, ivreg, stargazer, estimatr)


# Directory 
# base_directory <- "/Users/sarajohns/Desktop/ARE213_psets/pset3/"
#base_directory <- "/Users/beckycardinali/Desktop/ARE213_psets/pset3/"
base_directory <- "/Users/yuen/Documents/GitHub/ARE213_psets/pset3/"
# base_directory <- "C:\\Users\\jacob\\Documents\\GitHub\\ARE213_psets\\pset3\\"

# read data
data <- as.data.table(read_dta(paste0(base_directory, "2miledata.dta")))
allSites <- as.data.table(read_dta(paste0(base_directory, "allsites.dta")))
allCovariates <- as.data.table(read_dta(paste0(base_directory, "allcovariates.dta")))
siteCovariates <- as.data.table(read_dta(paste0(base_directory, "sitecovariates.dta")))
```

# Question 1: OLS Regressions

This question asks you to run OLS regressions that look at whether there is an association between 2000 housing values and whether a census tract contained a hazardous waste site that was placed on the NPL by 2000.


 (a) Use the file allsites.dta. This file contains only own tract housing variables (i.e. no 2 mile averages). Use "robust" standard errors for all regressions. First regress 2000 housing prices on whether the census tract had an NPL site in 2000. Include 1980 housing values as a control. Next add housing characteristics as controls. Run a third regression adding economic and demographic variables as controls. Finally run a 4th regression that also includes state fixed effects. Briefly interpret the regressions. Under what conditions will the coefficients on NPL 2000 status be unbiased?
 
\bigskip

```{r, include = TRUE}

## Regress 2000 housing prices on whether the census tract had an NPL site in 2000
## Use "robust" standard errors for all regressions

# 1980 housing values as a control
lm1 <- lm(lnmdvalhs0 ~ npl2000 + lnmeanhs8, allSites) 
summary(lm1, se = "white")

# Add housing characteristics as controls
lm2 <- lm(lnmdvalhs0 ~ npl2000 + lnmeanhs8 + tothsun8 + ownocc8 + firestoveheat80 +
            noaircond80 + nofullkitchen80 + zerofullbath80 + bedrms0_80occ + bedrms1_80occ +
            bedrms2_80occ + bedrms3_80occ + bedrms4_80occ + bedrms5_80occ + blt0_1yrs80occ +
            blt2_5yrs80occ + blt6_10yrs80occ + blt10_20yrs80occ + blt20_30yrs80occ + 
            blt30_40yrs80occ + blt40_yrs80occ + detach80occ + attach80occ + mobile80occ + 
            occupied80, allSites) 
summary(lm2, se = "white")

# Add economic and demographic variables as controls
lm3 <- lm(lnmdvalhs0 ~ npl2000 + lnmeanhs8 + tothsun8 + ownocc8 + firestoveheat80 +
            noaircond80 + nofullkitchen80 + zerofullbath80 + bedrms0_80occ + bedrms1_80occ +
            bedrms2_80occ + bedrms3_80occ + bedrms4_80occ + bedrms5_80occ + blt0_1yrs80occ +
            blt2_5yrs80occ + blt6_10yrs80occ + blt10_20yrs80occ + blt20_30yrs80occ + 
            blt30_40yrs80occ + blt40_yrs80occ + detach80occ + attach80occ + mobile80occ + 
            occupied80 + pop_den8 + shrblk8 + shrhsp8 + child8 + old8 + shrfor8 + ffh8 + smhse8 + hsdrop8 +
            no_hs_diploma8 + ba_or_better8 + unemprt8 + povrat8 + welfare8 + avhhin8, allSites) 
summary(lm3, se = "white")

# Add state fixed effects
lm4 <- feols(lnmdvalhs0 ~ npl2000 + lnmeanhs8 + tothsun8 + ownocc8 + firestoveheat80 +
            noaircond80 + nofullkitchen80 + zerofullbath80 + bedrms0_80occ + bedrms1_80occ +
            bedrms2_80occ + bedrms3_80occ + bedrms4_80occ + bedrms5_80occ + blt0_1yrs80occ +
            blt2_5yrs80occ + blt6_10yrs80occ + blt10_20yrs80occ + blt20_30yrs80occ + 
            blt30_40yrs80occ + blt40_yrs80occ + detach80occ + attach80occ + mobile80occ + 
            occupied80 +
            pop_den8 + shrblk8 + shrhsp8 + child8 + old8 + shrfor8 + ffh8 + smhse8 + hsdrop8 +
            no_hs_diploma8 + ba_or_better8 + unemprt8 + povrat8 + welfare8 + avhhin8,
            fixef = "statefips", data = allSites) 
summary(lm4, se = "white")

```
\bigskip

Taking our 4th regression as an example (with all controls and state fixed effects), we can interpret the results as having a hazardous waste site listed on the NPL by 2000 is associated with a `r round(100*lm4[["coefficients"]][1],2)` \% increase in median housing values in 2000, ceteris paribus. The coefficients on NPL 2000 status will be unbiased if the conditional independence assumption holds i.e if we have selection on observables ($(Y_i(1), Y_i(0)) \perp D_i | X_i$). The key assumption underlying a ``selection on observables" design is that the treatment is as good as randomly assigned after we condition on observables. In other words, we assume that we observe *all* the factors that affect treatment assignment (whether a census tract contained a hazardous waste site that was placed on the NPL by 2000) and are correlated with the potential outcomes (2000 housing values). If there is systematic selection into treatment, we assume this selection is only a function of the observables. That is, we assume that having a hazardous waste site placed on the NPL by 2000 is uncorrelated with unobservable determinants of 2000 housing values conditional on the observables. If these assumptions hold, then a regression of 2000 housing prices on whether the census tract had an NPL site in 2000, conditioning on observables, will estimate the ATE. Thus, the coefficients on NPL 2000 status will be unbiased under these conditions.

 (b) Here we will compare covariates between potential treatment and comparison groups. First, use allcovariates.dta to compare covariates (i.e. those used in the above regressions) between census tracts with and without a hazardous waste site listed on the NPL by 2000. Next, use sitecovariates.dta to compare covariates between those census tracts with a hazardous waste site that had an HRS test in 1982. Specifically, compare those with sites that scored above 28.5 to those that scored below 28.5. Finally, compare those census tracts with sites between 16.5 and 28.5 to census tracts with sites between 28.5 and 40.5. What conclusions do you draw from these 3 comparisons?
 
 \bigskip
 
```{r, include = TRUE}
## Compare covariates between census tracts with and without a hazardous waste site listed
## on the NPL by 2000 using allcovariates.dta

# no old8 in allcovariates.dta

# Make a log mean housing prices 1980 variable
allCovariates$lnmeanhs80 <- log(allCovariates$meanhs8)

summary_dt <- transpose(allCovariates[,lapply(.SD, mean, na.rm=TRUE), .SDcols = c(59, 23, 24, 28:31, 
                                                                                  40:56, 3:15, 17), 
                               by = npl2000])
summary_dt <- cbind(summary_dt, transpose(allCovariates[,lapply(.SD, sd, na.rm=TRUE), .SDcols = 
                                                          c(59, 23, 24, 28:31, 40:56, 3:15, 17), 
                                                 by = npl2000]))
colnames(summary_dt) <- c("No NPL means", "NPL means", "No NPL sd", "NPL sd")
summary_dt <- summary_dt[2:39,] 
summary_dt[, "Variable (1980 Values)" := c("Log mean housing values", "Total housing units in tract", 
                           "# owner-occupied units", "% units fire stove heat", 
                           "% units with no AC", "% units no full kitchen",
                           "% units with no full bath", "% own-occ units 0 bedrms",
                           "% own-occ units 1 bedrm",  "% own-occ units 2 bedrms",  
                           "% own-occ units 3 bedrms",  "% own-occ units 4 bedrms",  
                           "% own-occ units 5 bedrms", "% own-occ units built in last yr", 
                           "% own-occ units 2-5 yrs old", "% own-occ units 6-10 yrs old", 
                           "% own-occ units 10-20 yrs old", "% own-occ units 20-30 yrs old", 
                           "% own-occ units 30-40 yrs old", "% own-occ units 40+ yrs old", 
                           "% detached single family housing", "% attached single family housing",
                           "% mobile home single family", "% housing units occupied",
                           "Tract population density", "Share of pop black", "Share of pop Hispanic",
                           "Share of population < 18", "Share of population foreign born",
                           "Share of female headed HHs", "% pop in same house 5 yrs ago",
                           "% pop high school aged HS dropout", "% of pop > 25 with no HS diploma", 
                           "% pop > 25 with BA or better", "% pop > 16 unemployed", 
                           "% pop below poverty line", "% of HHs on public assistance",
                           "Average household income")]

formulas <- paste("allCovariates$", names(allCovariates)[c(59, 23, 24, 28:31, 40:56, 3:15, 17)], 
                  "~ allCovariates$npl2000")
t_test <- t(sapply(formulas, function(f) {      
  res <- t.test(as.formula(f))
  c(res$statistic, p.value=res$p.value)      
}))

colnames(t_test) <- c("t-stat", "p-value")

summary_dt <- cbind(summary_dt, t_test)
summary_dt[, Difference := `No NPL means` - `NPL means`]

setcolorder(summary_dt, c("Variable (1980 Values)", "No NPL means", "No NPL sd", "NPL means", 
                          "NPL sd", "Difference", "t-stat", "p-value"))

``` 

```{r, include=TRUE, results = 'asis'}

# First table for 1b

print(xtable(summary_dt, caption = "Difference in Means of Census Tracks Without Versus With a Site Listed on the NPL by 2000", digits = 2), include.rownames = FALSE, size = "small", comment = FALSE)

```
\bigskip

Table 1 suggests that census tracts with a hazardous waste site listed on the NPL by 2000 differ systematically from census tracts without such sites. Specifically, compared to tracts with such sites, census tracts without a site listed on the NPL by 2000 have on average higher mean housing values, fewer housing units, fewer owner-occupied units, smaller proportion of units with no AC, smaller proportion of units with no full bath, higher population density, higher share of black and hispanic populations, higher average household income, among other differences, all of which are statistically significant at at least the 5\% level. These results suggest that restricting comparisons to census tracts with a site listed on the NPL by 2000 may be a better strategy. 

\bigskip
```{r, include=TRUE}
## Compare covariates between census tracts with a hazardous waste site that had
## an HRS test in 1982 using sitecovariates.dta. Specifically, compare sites that
## scored above 28.5 to those that scored below 28.5

# no old8 in sitecovariates.dta

# Make a log mean housing prices 1980 variable
siteCovariates$lnmeanhs80 <- log(siteCovariates$meanhs8)

# Make a dummy for scoring <= 28.5 == 0 and scoring > 28.5 == 1
siteCovariates$HRSaboveThreshold <- 3
siteCovariates[, HRSaboveThreshold := ifelse(hrs_82 > 28.5, 1, 0)]

summary_dt_2 <- transpose(siteCovariates[,lapply(.SD, mean, na.rm=TRUE), .SDcols = c(61, 24, 25, 29:32,
                                                                                     41:57, 4:16, 18), 
                               by = HRSaboveThreshold])
summary_dt_2 <- cbind(summary_dt_2, transpose(siteCovariates[,lapply(.SD, sd, na.rm=TRUE), .SDcols = 
                                                          c(61, 24, 25, 29:32, 41:57, 4:16, 18), 
                                                 by = HRSaboveThreshold]))
colnames(summary_dt_2) <- c("HRS Below means", "HRS Above means", "HRS Below sd", "HRS Above sd")
summary_dt_2 <- summary_dt_2[2:39,] 
summary_dt_2[, "Variable (1980 Values)" := c("Log mean housing values", "Total housing units in tract", 
                           "# owner-occupied units", "% units fire stove heat", 
                           "% units with no AC", "% units no full kitchen",
                           "% units with no full bath", "% own-occ units 0 bedrms",
                           "% own-occ units 1 bedrm",  "% own-occ units 2 bedrms",  
                           "% own-occ units 3 bedrms",  "% own-occ units 4 bedrms",  
                           "% own-occ units 5 bedrms", "% own-occ units built in last yr", 
                           "% own-occ units 2-5 yrs old", "% own-occ units 6-10 yrs old", 
                           "% own-occ units 10-20 yrs old", "% own-occ units 20-30 yrs old", 
                           "% own-occ units 30-40 yrs old", "% own-occ units 40+ yrs old", 
                           "% detached single family housing", "% attached single family housing",
                           "% mobile home single family", "% housing units occupied",
                           "Tract population density", "Share of pop black", "Share of pop Hispanic",
                           "Share of population < 18", "Share of population foreign born",
                           "Share of female headed HHs", "% pop in same house 5 yrs ago",
                           "% pop high school aged HS dropout", "% of pop > 25 with no HS diploma", 
                           "% pop > 25 with BA or better", "% pop > 16 unemployed", 
                           "% pop below poverty line", "% of HHs on public assistance",
                           "Average household income")]

formulas <- paste("siteCovariates$", names(siteCovariates)[c(61, 24, 25, 29:32, 41:57, 4:16, 18)], 
                  "~ siteCovariates$HRSaboveThreshold")
t_test <- t(sapply(formulas, function(f) {      
  res <- t.test(as.formula(f))
  c(res$statistic, p.value=res$p.value)      
}))

colnames(t_test) <- c("t-stat", "p-value")

summary_dt_2 <- cbind(summary_dt_2, t_test)
summary_dt_2[, Difference := `HRS Below means` - `HRS Above means`]

setcolorder(summary_dt_2, c("Variable (1980 Values)", "HRS Below means", "HRS Below sd", "HRS Above means", 
                          "HRS Above sd", "Difference", "t-stat", "p-value"))

``` 

```{r, include=TRUE, results = 'asis'}

# Second table for 1b

print(xtable(summary_dt_2, caption = "Difference in Means of Census Tracks with a HRS Score Below Versus Above the 28.5 Threshold", digits = 2), 
      include.rownames = FALSE, size = "small", comment = FALSE)

```
\bigskip

The results from Table 2 suggest that among census tracts with a hazardous waste site that had an HRS test in 1982, tracts with a site that scored above the 28.5 threshold differ systematically from sites with a HRS score below the threshold. For example, census tracts with a site scoring below the threshold have on average lower mean housing values, higher share of female-headed households, higher share of population in the same house 5 years ago, higher proportion of population with no high school diploma, lower proportion of population with a college degree or better, a higher unemployment rate, a higher proportion of households on public assistance, and lower household income, among other differences, all of which are statistically significant at at least the 5\% level. 

\bigskip

```{r, include=TRUE}
## Compare covariates between census tracts with a hazardous waste site that had
## an HRS test in 1982 using sitecovariates.dta. Specifically, compare sites that
## scored between 16.5 and 28.5 to those that scored between 28.5 and 40.5

# no old8 in sitecovariates.dta

# drop observations with HRS below 16.5 or above 40.5
siteCovariates <- subset(siteCovariates, siteCovariates$hrs_82 <= 40.5)
siteCovariates <- subset(siteCovariates, siteCovariates$hrs_82 >= 16.5)

# HRSaboveThreshold from before is still the appropriate dummy since it keeps track of
# above or below 28.5 and we've removed observations outside the desired intervals

summary_dt_3 <- transpose(siteCovariates[,lapply(.SD, mean, na.rm=TRUE), .SDcols = c(61, 24, 25, 29:32,
                                                                                     41:57, 4:16, 18), 
                               by = HRSaboveThreshold])
summary_dt_3 <- cbind(summary_dt_3, transpose(siteCovariates[,lapply(.SD, sd, na.rm=TRUE), .SDcols = 
                                                          c(61, 24, 25, 29:32, 41:57, 4:16, 18), 
                                                 by = HRSaboveThreshold]))
colnames(summary_dt_3) <- c("HRS Below means", "HRS Above means", "HRS Below sd", "HRS Above sd")
summary_dt_3 <- summary_dt_3[2:39,] 
summary_dt_3[, "Variable (1980 Values)" := c("Log mean housing values", "Total housing units in tract", 
                           "# owner-occupied units", "% units fire stove heat", 
                           "% units with no AC", "% units no full kitchen",
                           "% units with no full bath", "% own-occ units 0 bedrms",
                           "% own-occ units 1 bedrm",  "% own-occ units 2 bedrms",  
                           "% own-occ units 3 bedrms",  "% own-occ units 4 bedrms",  
                           "% own-occ units 5 bedrms", "% own-occ units built in last yr", 
                           "% own-occ units 2-5 yrs old", "% own-occ units 6-10 yrs old", 
                           "% own-occ units 10-20 yrs old", "% own-occ units 20-30 yrs old", 
                           "% own-occ units 30-40 yrs old", "% own-occ units 40+ yrs old", 
                           "% detached single family housing", "% attached single family housing",
                           "% mobile home single family", "% housing units occupied",
                           "Tract population density", "Share of pop black", "Share of pop Hispanic",
                           "Share of population < 18", "Share of population foreign born",
                           "Share of female headed HHs", "% pop in same house 5 yrs ago",
                           "% pop high school aged HS dropout", "% of pop > 25 with no HS diploma", 
                           "% pop > 25 with BA or better", "% pop > 16 unemployed", 
                           "% pop below poverty line", "% of HHs on public assistance",
                           "Average household income")]

formulas <- paste("siteCovariates$", names(siteCovariates)[c(61, 24, 25, 29:32, 41:57, 4:16, 18)], 
                  "~ siteCovariates$HRSaboveThreshold")
t_test <- t(sapply(formulas, function(f) {      
  res <- t.test(as.formula(f))
  c(res$statistic, p.value=res$p.value)      
}))

colnames(t_test) <- c("t-stat", "p-value")

summary_dt_3 <- cbind(summary_dt_3, t_test)
summary_dt_3[, Difference := `HRS Below means` - `HRS Above means`]

setcolorder(summary_dt_3, c("Variable (1980 Values)", "HRS Below means", "HRS Below sd", "HRS Above means", "HRS Above sd", "Difference", "t-stat", "p-value"))

``` 

```{r, include=TRUE, results = 'asis'}

# Third table for 1b

print(xtable(summary_dt_3, caption = "Difference in Means of Census Tracks with a HRS Score Below Versus Above the 28.5 Threshold (bandwidth = 12 points)", digits = 2), 
      include.rownames = FALSE, size = "small", comment = FALSE)
```

\bigskip
The results reported in Table 3 suggest that census tracts above and below the threshold become more comparable when we shorten the bandwidth. That is, when we only compare census tracts that are within 12 points of the threshold on either side, most of the differences in observable characteristics become statistically insignificant. We do find a statistically significant difference in two variables, percentage of owner-occupied units with 2 bedrooms and percentage of population with a college degree, which is expected when we are testing balance across 38 variables at the 5\% level. 

# Question 2: Regression Discontinuity Design

 (a) Consider the HRS score as the running variable for an RD research design. What assumptions are needed on the HRS score? How do each of the below "facts" impact the appropriateness of these assumptions?

\bigskip
In order for regression discontinuity to be a valid research design, we need to assume that the potential outcomes $Y_i(0)$ and $Y_i(1)$ (housing prices) are smooth functions of the running variable $X_i$ (the HRS score) as it crosses the threshold $c$ (28.5). In other words, $E[Y_i(0) | X_i = x]$ and $E[Y_i(1) | X_i = x]$ are continuous in $x$. If there is imperfect compliance, that is if the probability of treatment increases, but by less than 100 pp, when the running variable crosses the threshold, then we need to use a fuzzy RD design. In this case, we need to make an additional monotonicity assumption that $D_i(x^*)$ is non-increasing in $x^*$ at $x^* = c$, that is we need to assume there are no "defiers." 

\bigskip

Importantly, our first assumption is violated if there is manipulation based on the HRS score. In other words, if individuals understand the assignment mechanism and can manipulate the HRS score to place a census block just above (or below) the threshold, then there is selection into treatment so census tracts just above and below the threshold are no longer comparable. Thus we need to assume that individuals cannot game the assignment mechanism in order for this to be a valid research design. Relatedly, we also need to assume that covariates are smooth at the threshold, that is that covariates are balanced above and below the threshold. If this is not true, then we have selection into treatment and observations just above and below the threshold are again not comparable. 

\bigskip

     (i) The EPA assertion that "the 28.5" cutoff was selected because it produced a manageable number
     of sites."

\bigskip
This fact makes it more likely that our assumptions hold, because the threshold was not selected based on specific site characteristics, which would have potentially made covariates imbalanced across the threshold. For example, if instead the "28.5" cutoff was selected because a HRS rating of 28.5 or higher is especially (disproportionately) dangerous for human health, then our first assumption will no longer hold because houses close to sites above this threshold may benefit disproportionately from treatment. 

     (ii) None of the individuals involved in identifying the site, testing the level of pollution, or 
     running the 1982 HRS test knew the cutoff threshold score.

\bigskip
This fact makes it more likely that our assumptions hold. In particular, if none of the individuals involved knew the cutoff threshold score, it is less likely they were able to manipulate the test results to make certain census tracts be above (or below) the threshold. Even if individuals had an incentive to cheat, without knowing the assignment mechanism they would not have been able to game the system effectively.

     (iii) EPA documentation emphasizes that the HRS test is an imperfect scoring measure

\bigskip
Whether this fact violates our assumptions depends on the type of error associated with the HRS test. If this is classical measurement error then it should not affect our assumptions. However, if the error is correlated with our covariates or with our outcome variable (housing prices) then this would violate our first assumption.

\bigskip
 (b) Create a histogram of the distribution of the 1982 HRS scores by dividing the HRS score into non-overlapping bins. Include a vertical line at 28.5. Next run local linear regressions on either side of 28.5 using the midpoints of the bins as the data. What do you conclude?

\bigskip

```{r, include = TRUE}
## histogram of the density of 1982 HRS scores
ggplot(data, aes(x = hrs_82)) +
  geom_histogram(binwidth = 1.5, boundary = 0, closed = "left", col = "navy", fill = "white") +
  geom_vline(xintercept = 28.5, linetype = "dashed", color = "red") +
  theme_gray() +
  scale_x_continuous(breaks = seq(0,75,5)) +
  xlab("Density of 1982 HRS scores") +
  ylab("Frequency") +
  ggtitle("Density of Running Variable around the Threshold") +
  theme_bw()

## Run local linear regressions on either side of threshold, using the midpoints of the bins as the data

range(data$hrs_82)# between 0 and 74.16
h = 1.5 #set bandwidth
bins = seq(from = 0, to = 75, by = h) # set cutoffs for bins
length(bins)

# returns the bin index for each observation
data$hrs_82_bin <- cut(data$hrs_82, breaks = bins, right = FALSE)

# calculate the midpoint of each bin
bins.midpoint = (bins[-1] + bins[-(length(bins))])/2

# assign a bin midpoint to each observation
data$hrs_82_binmid = bins.midpoint[ data$hrs_82_bin ]

# generate average of the treatment variable (NPL assignment) for each bin
npl2000_bin =tapply(data$npl2000, data$hrs_82_bin, mean)

# generate average outcome in each bin
lnmdvalhs0_nbr_bin = tapply(data$lnmdvalhs0_nbr, data$hrs_82_bin, mean)

# regression fitted on data below the cutoff
below_lm <- lm(lnmdvalhs0_nbr_bin ~ bins.midpoint, data.frame(lnmdvalhs0_nbr_bin, bins.midpoint)[1:19,])
summary(below_lm)

# regression fitted on data above the cutoff
above_lm <- lm(lnmdvalhs0_nbr_bin ~ bins.midpoint, data.frame(lnmdvalhs0_nbr_bin, bins.midpoint)[20:50,])
summary(above_lm)
```

\bigskip
We estimate the treatment effect $\hat{\tau} = \hat{\alpha}_r - \hat{\alpha}_l =$ `r round(above_lm[[1]][1], 3)` - `r round(below_lm[[1]][1],3)` = `r round(above_lm[[1]][1] - below_lm[[1]][1], 3)`, the difference in the estimated intercepts from our local linear regressions above and below the threshold. This is suggestive evidence that being above the threshold, and therefore being more likely to be placed on the NPL, is associated with higher mean housing prices in 2000. Of course, a drawback of fitting separate local linear regressions on either side of the threshold is that we cannot conduct statistical inference on our estimated treatment effect. 

# Question 3: First Stage of RD Design

 (a) Use a 2SLS (IV) econometric setup that uses whether or not a census tract has a site scoring above/below 28.5 as the instrument. Write down the 1st stage equation. Run the 1st stage regression experimenting with the same set of covariates used in question (1). In addition, run a second specification in which you limit the sample to only those census tracts with sites between 16.5 and 40.5 and run the specification using all of the control variables (we will use this as the size of the bandwidth for the “regression discontinuity” regression). Interpret the results.

\bigskip
```{r, include=FALSE}
data$above_28pt5 <- 0
data$above_28pt5[data$hrs_82 >= 28.5] <- 1
```

We can write the first stage as
$$
NPL_i = \delta_0 + \delta_1 1(HRS_i \ge 28.5) + \gamma X_i + \nu_i
$$
where the instrument for NPL status is whether HRS is above 28.5 and we control for other covariates. Now we estimate this first stage regression, including controls for population density, education (college educated), children, poverty rate, and home characteristics (no full kitchen, 3 or more bedrooms, mobile).
```{r}
first_stage <- lm(npl2000 ~ above_28pt5 + pop_den8_nbr + ba_or_better8_nbr + child8_nbr + povrat8_nbr +
                nofullkitchen80_nbr + bedrms3_80occ_nbr + mobile80occ_nbr,
              data = data)
summary(first_stage)
```
As expected, having HRS above 28.5 is strongly predictive of NPL status. Now we rerun our IV analysis but focusing on census tracts with HRS between 16.5 and 40.5
```{r}
data_narrow <- data[data$hrs_82 >= 16.5 & data$hrs_82 <= 40.5,]
first_stage <- lm(npl2000 ~ above_28pt5 + pop_den8_nbr + ba_or_better8_nbr + child8_nbr + povrat8_nbr +
                nofullkitchen80_nbr + bedrms3_80occ_nbr + mobile80occ_nbr,
              data = data_narrow)
summary(first_stage)
```
Here again the threshold is strongly predictve of NPL status.

\bigskip

 (b) Create a graph plotting the the 1982 HRS score against whether
a site is listed on the NPL by year 2000 (NPL on the y-axis, HRS
on the x -axis). Briefly explain and interpret this graph.

```{r}
(ggplot(data_narrow, aes(x=data_narrow$hrs_82,y=data_narrow$npl2000)) +
  geom_point(alpha = 0.4) +
  stat_summary_bin(fun='mean', bins=20,
                   color='orange', size=2, geom='point')) +
  geom_vline(xintercept=28.5, linetype="dashed") +
  ylab("NPL Status in 2000") +
  xlab("HRS Scores in 1982") +
  theme_bw()
```
Here the yellow dots are the binned means and the black dots are the observed values. With and HRS score below 28.5, there is still a reasonable change (around 25%) that the site will be added to the NPL. With HRS above 28.5, it is almost guaranteed (the graph shows one exception).

```{r}
(ggplot(data_narrow, aes(x=data_narrow$hrs_82,y=data_narrow$meanhs8)) +
  geom_point(alpha = 0.4) +
  stat_summary_bin(fun='mean', bins=20,
                   color='orange', size=2, geom='point')) +
  geom_vline(xintercept=28.5, linetype="dashed") +
  ylab("Mean Household Prices in 1980") +
  xlab("HRS Score 1982") +
  theme_bw()
```
There aren't any obvious differences in this range of HRS values. If anything, a higher HRS appears to be correlated with slightly higher housing values, which would cause our estimates to be downward biased, if anything. All in all, the values are largely comparable across this range.
```{r, include=FALSE}
rm(first_stage)
```

# Question 4: Second Stage of RD Design

Write down the 2nd stage equation (with housing values as the outcome) and the 2 standard assumptions for valid IV estimation. Run 2SLS to get the estimated coefficient on 2000 NPL status. Run the same two specifications as in the previous question. Briefly interpret the results.

\bigskip

The 2nd stage equation is 

$$ P_{i} = \beta_0 + \beta_1 \hat{NPL_i} + \psi X_i + \varepsilon_i$$
where $P_i$ is the logged mean housing price in 2000, $\hat{NPL_i}$ are the fitted values from the first stage, and the set of covariates is the same as in the first stage. The two assumptions for valid IV estimation are: 1) $Cov(z_i, d_i) \neq 0$ (relevance of the instrument) which our first stage showed we satisfy, and 2) $Cov(z_i, \epsilon_i)$ (exogeneity) which the facts and discussion in question 2 suggest we satisfy. We estimate the 2SLS regression for the full dataset and for a subset of census tracts with sites between 16.5 and 40.5. 

```{r}
iv_reg_full <- iv_robust(lnmdvalhs0_nbr~ npl2000 + pop_den8_nbr + ba_or_better8_nbr + child8_nbr + povrat8_nbr +
                nofullkitchen80_nbr + bedrms3_80occ_nbr + mobile80occ_nbr |
                  above_28pt5 + pop_den8_nbr + ba_or_better8_nbr + child8_nbr + povrat8_nbr +
                nofullkitchen80_nbr + bedrms3_80occ_nbr + mobile80occ_nbr, 
                data = data, se_type = "HC1")
summary(iv_reg_full, digits=4)
```



```{r}
iv_reg_narrow <- iv_robust(lnmdvalhs0_nbr ~ npl2000 + pop_den8_nbr + ba_or_better8_nbr + child8_nbr + povrat8_nbr +
                nofullkitchen80_nbr + bedrms3_80occ_nbr + mobile80occ_nbr |
                  above_28pt5 + pop_den8_nbr + ba_or_better8_nbr + child8_nbr + povrat8_nbr +
                nofullkitchen80_nbr + bedrms3_80occ_nbr + mobile80occ_nbr, 
                data = data_narrow, se_type = "HC1")
summary(iv_reg_narrow, digits = 4)

```

# Question 5: Conclusion
